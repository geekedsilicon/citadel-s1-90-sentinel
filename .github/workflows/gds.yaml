# ==============================================================================
# VAELIX | SENTINEL MARK I ‚Äî GDSII HARDENING PIPELINE
# ==============================================================================
# FILE:      .github/workflows/gds.yaml
# VERSION:   1.2.0 ‚Äî Citadel Standard
# TARGET:    Tiny Tapeout 06 (IHP 130nm SG13G2) ‚Äî ttihp26a Shuttle
# REPO:      citadel-s1-90-sentinel
#
# PURPOSE:
#   Converts S1-90 Sentinel RTL to physical GDSII layout via LibreLane.
#   Deploys the interactive layout viewer to GitHub Pages on completion.
#
# PIPELINE ORDER:
#   gds ‚Üí viewer
#
# NOTE ‚Äî SENTINEL VS CORE PIPELINE:
#   This pipeline runs gds + viewer only.
#   citadel-s1-90-core additionally runs precheck + gl_test.
#   Do NOT add those jobs here ‚Äî the sentinel is Wokwi-based and does
#   not have the gate-level netlist infrastructure those jobs require.
#
# ‚ö†Ô∏è  LIBRELANE VERSION WARNING:
#   librelane-version: 3.0.0.dev44 is the MANDATORY pre-release version
#   for the IHP26a shuttle. DO NOT upgrade without explicit TinyTapeout
#   shuttle coordinator approval.
#
# FIX LOG:
#   v1.2.0 ‚Äî [SECURITY] Added path sanitization to prevent runner info leakage
#   v1.1.0 ‚Äî [CRITICAL] Removed 'branches: main' filter from push trigger
#             GDS must build on all branches, not just main.
#   v1.1.0 ‚Äî Added concurrency guard (cancels stale hardening runs)
#   v1.1.0 ‚Äî Step names normalized to match cross-repo Citadel standard
#   v1.1.0 ‚Äî Added librelane version warning comment
#   v1.0.0 ‚Äî librelane-version pinned to 3.0.0.dev44 (IHP26a requirement)
#   v1.0.0 ‚Äî Tag updated to ttihp26a
# ==============================================================================

name: gds

on:
  push:
  workflow_dispatch:

# Cancel any in-progress hardening run when a newer push arrives.
# GDS synthesis is the most expensive job ‚Äî never let stale runs hold runners.
concurrency:
  group: "gds"
  cancel-in-progress: true

jobs:
  # ----------------------------------------------------------------------------
  # JOB 1: GDS HARDENING
  # Runs LibreLane on the IHP SG13G2 PDK to produce the GDSII file.
  # Viewer job depends on successful completion of this job.
  # ----------------------------------------------------------------------------
  gds:
    runs-on: ubuntu-24.04
    env:
      # Sanitize paths in logs to prevent runner username/structure leakage
      # GitHub Actions automatically masks secret values, but we need to
      # prevent local paths from revealing runner infrastructure details
      RUNNER_WORKSPACE_SANITIZED: "/workspace"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Sanitize environment paths
        run: |
          echo "üîí Sanitizing runner path information..."
          # Mask the actual runner workspace path in GitHub Actions logs
          echo "::add-mask::$GITHUB_WORKSPACE"
          echo "::add-mask::$HOME"
          echo "::add-mask::$(pwd)"
          echo "::add-mask::$(dirname $GITHUB_WORKSPACE)"
          echo "Working directory: [SANITIZED]"

      - name: Check Wokwi project ID
        id: check_wokwi
        run: |
          WOKWI_ID=$(grep -E '^  wokwi_id:' info.yaml | awk '{print $2}' | tr -d ' ')
          echo "wokwi_id=$WOKWI_ID"
          if [ "$WOKWI_ID" = "0" ]; then
            echo "‚ö†Ô∏è  Wokwi ID is 0 - using custom Verilog project"
          else
            echo "‚úì Wokwi ID found: $WOKWI_ID"
          fi

      - name: Build GDS
        uses: TinyTapeout/tt-gds-action@ttihp26a
        with:
          pdk: ihp-sg13g2
          # ‚ö†Ô∏è MANDATORY VERSION ‚Äî do not upgrade without shuttle approval.
          librelane-version: 3.0.0.dev44

  # ----------------------------------------------------------------------------
  # JOB 2: LAYOUT VIEWER DEPLOYMENT
  # Deploys the interactive GDSII viewer to GitHub Pages.
  # Requires pages and id-token permissions for authenticated deployment.
  # ----------------------------------------------------------------------------
  viewer:
    needs: gds
    runs-on: ubuntu-24.04
    permissions:
      pages: write # Required to deploy to GitHub Pages
      id-token: write # Required to verify deployment origin
    steps:
      - name: Deploy layout viewer
        uses: TinyTapeout/tt-gds-action/viewer@ttihp26a
