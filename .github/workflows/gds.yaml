# ==============================================================================
# VAELIX | SENTINEL MARK I ‚Äî GDSII HARDENING PIPELINE
# ==============================================================================
# FILE:      .github/workflows/gds.yaml
# VERSION:   1.2.0 ‚Äî Citadel Standard + The Warden
# TARGET:    Tiny Tapeout 06 (IHP 130nm SG13G2) ‚Äî ttihp26a Shuttle
# REPO:      citadel-s1-90-sentinel
#
# PURPOSE:
#   Converts S1-90 Sentinel RTL to physical GDSII layout via LibreLane.
#   Deploys the interactive layout viewer to GitHub Pages on completion.
#
# PIPELINE ORDER:
#   gds ‚Üí metrics ‚Üí viewer
#
# NOTE ‚Äî SENTINEL VS CORE PIPELINE:
#   This pipeline runs gds + metrics + viewer.
#   citadel-s1-90-core additionally runs precheck + gl_test.
#   Do NOT add those jobs here ‚Äî the sentinel is Wokwi-based and does
#   not have the gate-level netlist infrastructure those jobs require.
#
# ‚ö†Ô∏è  LIBRELANE VERSION WARNING:
#   librelane-version: 3.0.0.dev44 is the MANDATORY pre-release version
#   for the IHP26a shuttle. DO NOT upgrade without explicit TinyTapeout
#   shuttle coordinator approval.
#
# FIX LOG:
#   v1.2.0 ‚Äî [FEATURE] Added metrics comparison job (THE WARDEN)
#             Compares cell count against main branch baseline.
#             Fails build if gate count increases > 5% without bypass.
#             Bypass via '[bypass-metrics]' in commit or workflow input.
#   v1.1.0 ‚Äî [CRITICAL] Removed 'branches: main' filter from push trigger
#             GDS must build on all branches, not just main.
#   v1.1.0 ‚Äî Added concurrency guard (cancels stale hardening runs)
#   v1.1.0 ‚Äî Step names normalized to match cross-repo Citadel standard
#   v1.1.0 ‚Äî Added librelane version warning comment
#   v1.0.0 ‚Äî librelane-version pinned to 3.0.0.dev44 (IHP26a requirement)
#   v1.0.0 ‚Äî Tag updated to ttihp26a
# ==============================================================================

name: gds

on:
  push:
  workflow_dispatch:
    inputs:
      bypass_metrics:
        description: 'Bypass metrics threshold check'
        required: false
        type: boolean
        default: false

# Cancel any in-progress hardening run when a newer push arrives.
# GDS synthesis is the most expensive job ‚Äî never let stale runs hold runners.
concurrency:
  group: "gds"
  cancel-in-progress: true

jobs:
  # ----------------------------------------------------------------------------
  # JOB 1: GDS HARDENING
  # Runs LibreLane on the IHP SG13G2 PDK to produce the GDSII file.
  # Viewer job depends on successful completion of this job.
  # ----------------------------------------------------------------------------
  gds:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Check Wokwi project ID
        id: check_wokwi
        run: |
          WOKWI_ID=$(grep -E '^  wokwi_id:' info.yaml | awk '{print $2}' | tr -d ' ')
          echo "wokwi_id=$WOKWI_ID"
          if [ "$WOKWI_ID" = "0" ]; then
            echo "‚ö†Ô∏è  Wokwi ID is 0 - using custom Verilog project"
          else
            echo "‚úì Wokwi ID found: $WOKWI_ID"
          fi

      - name: Build GDS
        uses: TinyTapeout/tt-gds-action@ttihp26a
        with:
          pdk: ihp-sg13g2
          # ‚ö†Ô∏è MANDATORY VERSION ‚Äî do not upgrade without shuttle approval.
          librelane-version: 3.0.0.dev44

      # Store synthesis metrics for comparison
      - name: Upload synthesis metrics
        uses: actions/upload-artifact@v4
        with:
          name: synthesis-metrics-current
          path: runs/wokwi/

  # ----------------------------------------------------------------------------
  # JOB 2: METRICS COMPARISON (THE WARDEN)
  # Compares cell count (gate count) against main branch.
  # Power consumption is correlated with gate count in digital designs.
  # Fails build if gate count increases by more than 5% without bypass.
  # ----------------------------------------------------------------------------
  metrics:
    needs: gds
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download current branch metrics
        uses: actions/download-artifact@v4
        with:
          name: synthesis-metrics-current
          path: runs-current/

      - name: Extract current branch metrics
        id: current_metrics
        run: |
          # Find and parse synthesis log for cell count
          LOG_FILE=$(find runs-current/ -name "*.log" -type f | xargs grep -l "Number of cells" | head -1)

          if [ -z "$LOG_FILE" ]; then
            echo "Error: Could not find synthesis log with cell count"
            exit 1
          fi

          # Extract cell count from Yosys statistics
          CELL_COUNT=$(grep "Number of cells:" "$LOG_FILE" | tail -1 | grep -oE '[0-9]+' | head -1)

          if [ -z "$CELL_COUNT" ]; then
            echo "Error: Could not extract cell count from log"
            exit 1
          fi

          echo "cell_count=$CELL_COUNT" >> $GITHUB_OUTPUT
          echo "üìä Current branch cell count: $CELL_COUNT"

      - name: Checkout main branch for comparison
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: recursive
          path: main-repo

      - name: Build GDS for main branch
        run: |
          # Save current directory
          ORIGINAL_DIR=$(pwd)

          # Change to main branch directory
          cd main-repo

          # Clone tt-support-tools
          git clone https://github.com/TinyTapeout/tt-support-tools.git tt

          # Setup Python requirements
          pip install -r tt/requirements.txt

          # Create user config and build
          ./tt/tt_tool.py --create-user-config --ihp

          # Install LibreLane
          pip install librelane==3.0.0.dev44

          # Harden the design
          ./tt/tt_tool.py --harden --ihp

          # Return to original directory
          cd "$ORIGINAL_DIR"

      - name: Extract main branch metrics
        id: main_metrics
        run: |
          # Find and parse synthesis log for cell count from main-repo
          LOG_FILE=$(find main-repo/runs/wokwi/ -name "*.log" -type f 2>/dev/null | xargs grep -l "Number of cells" 2>/dev/null | head -1)

          if [ -z "$LOG_FILE" ]; then
            echo "‚ö†Ô∏è  Warning: Could not find main branch synthesis log"
            echo "Skipping comparison (main branch may not have been built yet)"
            echo "cell_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          CELL_COUNT=$(grep "Number of cells:" "$LOG_FILE" | tail -1 | grep -oE '[0-9]+' | head -1)

          if [ -z "$CELL_COUNT" ]; then
            echo "‚ö†Ô∏è  Warning: Could not extract main branch cell count"
            echo "cell_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "cell_count=$CELL_COUNT" >> $GITHUB_OUTPUT
          echo "üìä Main branch cell count: $CELL_COUNT"

      - name: Compare metrics and enforce threshold
        run: |
          CURRENT_CELLS=${{ steps.current_metrics.outputs.cell_count }}
          MAIN_CELLS=${{ steps.main_metrics.outputs.cell_count }}

          # Check for manual bypass via workflow input or commit message
          BYPASS_INPUT="${{ github.event.inputs.bypass_metrics }}"
          BYPASS_COMMIT=$(git log -1 --pretty=%B | grep -i "\[bypass-metrics\]" || echo "")

          # Validate that we have numeric values
          if [ -z "$MAIN_CELLS" ] || [ "$MAIN_CELLS" -eq "0" ]; then
            echo "‚ö†Ô∏è  No baseline metrics from main branch - skipping comparison"
            exit 0
          fi

          if [ -z "$CURRENT_CELLS" ]; then
            echo "‚ùå Error: Could not extract current branch metrics"
            exit 1
          fi

          if [ "$BYPASS_INPUT" = "true" ] || [ ! -z "$BYPASS_COMMIT" ]; then
            echo "‚úì Manual bypass detected - skipping threshold check"
            echo "  Current: $CURRENT_CELLS cells | Main: $MAIN_CELLS cells"
            exit 0
          fi

          # Calculate percentage change (with division by zero safety)
          CHANGE=$(echo "scale=2; ($CURRENT_CELLS - $MAIN_CELLS) * 100 / $MAIN_CELLS" | bc)

          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  METRICS COMPARISON (THE WARDEN)"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  Current branch: $CURRENT_CELLS cells"
          echo "  Main branch:    $MAIN_CELLS cells"
          echo "  Change:         $CHANGE%"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""

          # Check if change is an increase and exceeds threshold (5%)
          IS_INCREASE=$(echo "$CHANGE > 0" | bc)
          EXCEEDS_THRESHOLD=$(echo "$CHANGE > 5" | bc)

          if [ "$IS_INCREASE" -eq "1" ] && [ "$EXCEEDS_THRESHOLD" -eq "1" ]; then
            echo "‚ùå GATE COUNT INCREASE EXCEEDS 5% THRESHOLD"
            echo ""
            echo "   Increase: $CHANGE% (threshold: 5%)"
            echo ""
            echo "   To bypass this check:"
            echo "   - Include '[bypass-metrics]' in your commit message, OR"
            echo "   - Manually trigger workflow with 'bypass_metrics' option enabled"
            echo ""
            exit 1
          elif [ "$IS_INCREASE" -eq "1" ]; then
            echo "‚úì Gate count increased by $CHANGE% (within 5% threshold)"
          else
            echo "‚úì Gate count decreased or unchanged ($CHANGE%)"
          fi

  # ----------------------------------------------------------------------------
  # JOB 3: LAYOUT VIEWER DEPLOYMENT
  # Deploys the interactive GDSII viewer to GitHub Pages.
  # Requires pages and id-token permissions for authenticated deployment.
  # ----------------------------------------------------------------------------
  viewer:
    needs: [gds, metrics]
    runs-on: ubuntu-24.04
    permissions:
      pages: write # Required to deploy to GitHub Pages
      id-token: write # Required to verify deployment origin
    steps:
      - name: Deploy layout viewer
        uses: TinyTapeout/tt-gds-action/viewer@ttihp26a
